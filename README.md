# Lottery Chaser

****

_Шуточное приложение, не является казино._

Мы рады вам представить новую лотерею из коробки — **"Lottery Chaser"**. Вы можете легко и просто развернуть ее на своем сервере.

**Начнем**

Загрузите полученный вами файл `docker-compose.yml` в корень вашего сервера с установленным `Docker Compose` посредством SSH, а остальное мы уже сделали за вас ;)

В директории данного файла запустите 
```shell
docker-compose up
```

Наберитесь терпения пока процесс завершится, в соседнем терминале вы можете воспользоваться следующей командой, чтобы убедиться, что все контейнеры работают исправно
```shell
docker ps -a
```

Контейнеры с именами `web`, `php`, `mysql` должны быть в статусе `Up ***`.

С помощью следующей команды давайте зайдем в контейнер `php`
```shell
docker exec -it php bash
```

Находясь в контейнере выполним базовую настройку модулей
```shell
php pitmanager install
```

В ответ скрипт-помощник должен вывести красивую надпись, что все прошло хорошо.

И теперь действительно можно перейти по адресу `http://<SERVER_IP>:8181` и убедиться, что приложение работает.

Но в систему еще не загружены настройки очков, денег, вещей. Давайте разберемся как это делать.

**Изменение базовых настроек**

На помощь нам придет все тот же `pitmanager`. Если вы уже вышли с контейнера, повторите вход

```shell
docker exec -it php bash
```

Ряд следующих команд позволит как в самом начале настроить приложение, так и обращаться к ним в последствии.

Пополнение банка деньгами:
```shell
php pitmanager addmoney 100
```
_Вместо 100 укажите любую сумму, которую вы позволяете разыгрыывать. Сумма дополнит банк._

Допустимый интервал выигрыша денег:
```shell
php pitmanager rangemoney 1 10
```
_Указанный пример установит минимальную границу приза в 1, и максимальную в 10._

После выигрыша денег у игрока есть возможность зачислить их на бонусный счет с некоторым коэффициентом конвертации. По умолчанию он равен 1, но вы можете задать его своим командой:
```shell
php pitmanager ratiomoney 2
```

Ну и наконец, чтобы отправить выигранные игроками деньги в банк, воспльзуйтесь командой:
```shell
php pitmanager transfermoney 10
```
_Где 10 означает количество транзакций, которые надо обработать за раз._

В отличии от денег, баллы не ограничены, но интервал выпадения баллов за раз задать следует. Сделать это можно командой:
```shell
php pitmanager rangepoints 1 100
```
_Указанный пример установит минимальную границу приза в 1, и максимальную в 100._

Ну и последнее, розыгрыш мерчей. Чтобы добавить общее количество вещей на вашем складе воспользуйтесь командой:
```shell
php pitmanager addmerch 100
```
_Где 100 это ваше текущее количество вещей, при достижении нулевого остапка, игроки не смогут их вытаскивать._


**Разработчикам: свой вариант игры**

Хотите дополнить приложение новым вариантом игры? Нет ничего проще! Нужно лишь знать некоторые моменты.

В папке `app/Games` разместите ваш новый класс, который имплементирует интерфейс `Lottery\Contracts\GameInterface`.

Вам нужно определить следующие методы в своем классе.

1. Уникальный сивмольный код своего класса. Короткий и понятный, в идеале дублирует имя класса.
```injectablephp
public static function getCode(): string;
```

2. Название своего варианта игры. Именно он будет появляться игроку, когда выпадет ваш вариант игры.
```injectablephp
public static function getTitle(): string;
```

3. После того как игроку выпал ваш вариант игры, и он получил приз, вы можете предоставить ему список действий. Как обрабатывать такие действия мы обсудим ниже.
```injectablephp
public static function getActions(): array
{
    return [
        'bank' => 'Transfer to bank (by default)',
        'points' => 'Transfer to points',
        'refuse' => 'Refuse',
    ];
}
```

4. Данный метод вызывается когда игроку выпал ваш вариант игры. На данном шаге вы уже должны произвести все необходимые действия. Например, добавить баллы на счет игрока. Вернуть метод должен величину выигрыша. Например, величину баллов, которые уже были добавлены на счет игрока.
```injectablephp
public static function rollResult(int $userId);
```

5. Данный метод форматирует выигрыш для показа игроку. Здесь вы можете написать что угодно.
```injectablephp
public static function formatResult($result): string
{
    return "\${$result}";
}
```

6. Ну и, наконец, данный метод обрабатывает ответ игрока на то или иное действие после выпадания ему приза. Например, если игрок выбрал "зачислить выигрыш на счет", это обрабатывается в данном методе в зависимости от параметра `$code` (код выбранного действия). Если вернуть `true`, данная транзакция считается обработанной и не требует далее внимание менеджеров. 
```injectablephp
public static function actionRound(int $userId, $result, string $code): bool;
```

7. Теперь системе надо сообщить, что появился новый вариант игры. Для этого в методе `\Lottery\Kernel::getProviders` пропишите свой класс.
```injectablephp
public static function getProviders(): array
{
    return [
        Games\Merch::class,
        Games\Money::class,
        //...
        Games\YOUR_NEW_CLASS::class,
        //...
        Providers\System::class,
    ];
}
```

**Разработчикам: регистрация своей модели**

Ваш вариант игры может использовать сколь угодно сложные таблицы и их связь. Чтобы зарегистрировать ORM модель для взаимодействия в вашем варианте, сделайте следующее.

В `app/Models/` разместите свой класс-наследник от класса CRM, который имплементирует вспомогательный интерфейс.
```injectablephp
class Option extends \SimpleORM\Model implements \Lottery\Contracts\ModelInterface
...
```

В вашем классе модели вам нужно определить следующие методы.

Метод, который возвращает название таблицы:
```injectablephp
protected static function getTableName(): string
{
    return 'options';
}
```

Метод, который выоплняет создание таблицы (таблиц). Обратите внимание, что метод может запускаться повторно.
```injectablephp
public static function install(): void
{
    Database::arbitraryQuery("
        create table if not exists `options`
        (
            code varchar(50) not null,
            val varchar(50) not null,
            index ix_code (code)
        );
    ");
}
```

Наконец, метод, который проверит входящие поля при добавлении новой записи в вашу табицу. И либо вернет `null` (нет ошибок), либо текст ошибки. Также метод может изменять значения полей по ссылке.
```injectablephp
public static function beforeInsert(array &$fields): ?string
```

Теперь системе надо сообщить, что появился новая модель. Для этого в методе `\Lottery\Kernel::getModels` пропишите свой класс.
```injectablephp
public static function getModels(): array
{
    return [
        Models\Option::class,
        Models\Round::class,
        //...
        Models\YOUR_MODEL::class,
        //...
        Models\User::class,
    ];
}
```

**Разработчикам: регистрация консольных команд**

Возможно вы захотите свой вариант игры научить взаимодействую с администратором. Например, добавление интервалов, максимальных величин, процессингу, и так далее. Сделать это можно следующим образом.

Во-первых, добавьте интерфейс вашему классу игры `Lottery\Contracts\PitManagerInterface`. 

Далее вам надо реализовать два метода.

Первый — обработка всех входящих команд в консоли, чтобы сказать "да, это моя команда, я ее обработаю".
```injectablephp
public static function checkConsoleCommand(string $command, ...$args): bool
{
    return
        ($command === 'addmerch') && is_numeric($args[0] ?? null)
    ;
}
```

Тут просто проверяем саму команду и входящие параметры. Их может быть сколь угодно, разделенных пробелом.

Второй метод — обработка самой команды.
```injectablephp
public static function execConsoleCommand(string $command, ...$args): ?string
```

Тут мы совершаем необходимые действия в зависимости от команды и параметров. В ответ возвращаем сообщение об успешной обработке:
```injectablephp
    return \Lottery\PitManager::formatMessage(
        "The amount was successfully add, current amount is: $currentAmount"
    );
```

Ну или ошибку, если что-то пошло не так:
```injectablephp
return \Lottery\PitManager::formatError(
    'Error occurred during the merch add'
);
```

****

Ну вот и все. Интересных розыгрышей вашим игрокам!